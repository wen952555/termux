#!/bin/bash

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

BOT_FILE="bot.py"
PM2_NAME="termux-bot"
TOKEN_FILE=".tunnel_token"
BOOT_DIR="$HOME/.termux/boot"

echo -e "${GREEN}=== Termux è‡ªåŠ¨ä¿®å¤ä¸å¯åŠ¨è„šæœ¬ ===${NC}"

# --- 1. åŸºç¡€ä¾èµ–ä¿®å¤ ---

check_packages() {
    echo -e "${YELLOW}[1/5] æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ...${NC}"
    
    # ç¡®ä¿ pkg å¯ç”¨
    if ! command -v pkg &> /dev/null; then
        echo -e "${RED}âŒ é”™è¯¯: pkg å‘½ä»¤ä¸¢å¤±ï¼Œç¯å¢ƒå¯èƒ½å·²æŸåã€‚${NC}"
        exit 1
    fi

    # è‡ªåŠ¨ä¿®å¤ termux-api (é˜²æ­¢è¢«ç³»ç»Ÿè¯¯åˆ )
    if ! command -v termux-camera-record &> /dev/null; then
        echo -e "${YELLOW}>> æ­£åœ¨æ¢å¤ termux-api...${NC}"
        pkg update -y -o Dpkg::Options::="--force-confnew"
        pkg install termux-api -y
    fi

    # æ£€æŸ¥ Python ç¯å¢ƒ
    if ! command -v python &> /dev/null; then
        echo -e "${YELLOW}>> æ­£åœ¨å®‰è£… Python...${NC}"
        pkg install python -y
    fi
    
    # æ£€æŸ¥ Python ä¾èµ–
    if ! python -c "import telegram" &> /dev/null; then
        echo -e "${YELLOW}>> æ­£åœ¨å®‰è£… Python åº“...${NC}"
        pip install -r requirements.txt
    fi

    # æ£€æŸ¥ PM2
    if ! command -v pm2 &> /dev/null; then
        echo -e "${YELLOW}>> æ­£åœ¨å®‰è£… PM2...${NC}"
        if ! command -v npm &> /dev/null; then
             pkg install nodejs -y
        fi
        npm install -g pm2
    fi
}

# --- 2. Cloudflare éš§é“ä¿®å¤ ---

check_cloudflared() {
    echo -e "${YELLOW}[2/5] æ£€æŸ¥ Cloudflare ç»„ä»¶...${NC}"
    
    if [ ! -f "./cloudflared" ]; then
        echo -e "${YELLOW}>> ä¸‹è½½ cloudflared...${NC}"
        ARCH=$(uname -m)
        case $ARCH in
            aarch64) CF_ARCH="arm64" ;;
            arm*) CF_ARCH="arm" ;;
            x86_64) CF_ARCH="amd64" ;;
            *) echo -e "${RED}ä¸æ”¯æŒçš„æ¶æ„: $ARCH${NC}"; return ;;
        esac
        
        curl -L --output cloudflared "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-android-$CF_ARCH"
        chmod +x cloudflared
    fi
}

# --- 3. å¯åŠ¨éš§é“ ---

start_tunnel() {
    local INPUT_TOKEN=$1

    # 1. ä¿å­˜ Token (å¦‚æœæœ‰è¾“å…¥)
    if [ -n "$INPUT_TOKEN" ]; then
        echo "$INPUT_TOKEN" > "$TOKEN_FILE"
        echo -e "${GREEN}âœ… Tunnel Token å·²ä¿å­˜è‡³æœ¬åœ°${NC}"
    fi

    # 2. è¯»å– Token
    if [ -f "$TOKEN_FILE" ]; then
        TOKEN=$(cat "$TOKEN_FILE")
    else
        TOKEN=""
    fi

    # 3. æ£€æŸ¥ Token æ˜¯å¦å­˜åœ¨
    if [ -z "$TOKEN" ]; then
        echo -e "${RED}âŒ é”™è¯¯: æœªæ‰¾åˆ° Tunnel Tokenã€‚${NC}"
        echo -e "è¯·è¿è¡Œ: ./start_bot.sh tunnel <ä½ çš„Token>"
        return
    fi

    echo -e "${YELLOW}[3/5] å¯åŠ¨ Cloudflare éš§é“...${NC}"
    # åœæ­¢æ—§çš„è¿›ç¨‹
    pkill -f cloudflared > /dev/null 2>&1
    
    # åå°å¯åŠ¨
    nohup ./cloudflared tunnel run --token $TOKEN > cloudflared.log 2>&1 &
    
    sleep 2
    if pgrep -f cloudflared > /dev/null; then
        echo -e "${GREEN}âœ… éš§é“è¿è¡Œä¸­ (Cloudflare Tunnel)${NC}"
    else
        echo -e "${RED}âš ï¸ éš§é“å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Token æ˜¯å¦æ­£ç¡®${NC}"
        cat cloudflared.log
    fi
}

# --- 4. é…ç½®å¼€æœºè‡ªå¯ (æ— äººå€¼å®ˆæ¨¡å¼) ---

setup_autostart() {
    echo -e "${YELLOW}[é…ç½®å¼€æœºè‡ªå¯]...${NC}"
    
    # 1. æ£€æŸ¥æ˜¯å¦å®‰è£…äº† Termux:Boot åº”ç”¨
    if [ ! -d "$BOOT_DIR" ]; then
        echo -e "${RED}âŒ æœªæ£€æµ‹åˆ° Termux:Boot ç›®å½• ($BOOT_DIR)${NC}"
        echo -e "è¯·åŠ¡å¿…å…ˆå®‰è£… 'Termux:Boot' APP (å¯åœ¨ F-Droid æˆ– Google Play ä¸‹è½½)"
        echo -e "å®‰è£…åï¼Œè¯·è¿è¡Œä¸€æ¬¡ Termux:Boot åº”ç”¨ä»¥åˆå§‹åŒ–ã€‚"
        mkdir -p "$BOOT_DIR"
    fi

    # 2. è·å–å½“å‰è„šæœ¬ç»å¯¹è·¯å¾„
    PROJECT_DIR=$(pwd)
    BOOT_SCRIPT="$BOOT_DIR/start_bot_service"

    echo -e "æ­£åœ¨ç”Ÿæˆå¯åŠ¨è„šæœ¬: $BOOT_SCRIPT"

    # 3. å†™å…¥å¯åŠ¨è„šæœ¬
    cat > "$BOOT_SCRIPT" <<EOF
#!/data/data/com.termux/files/usr/bin/sh
# Termux Boot Script generated by BotGen AI

# 1. ç”³è¯·å”¤é†’é”ï¼Œé˜²æ­¢æ‰‹æœºä¼‘çœ æ–­ç½‘
termux-wake-lock

# 2. ç­‰å¾…ç½‘ç»œè¿æ¥ (ç»™ wifi è¿æ¥ä¸€ç‚¹æ—¶é—´)
sleep 10

# 3. è¿›å…¥é¡¹ç›®ç›®å½•å¹¶å¯åŠ¨
cd "$PROJECT_DIR"
./start_bot.sh start >> boot.log 2>&1
EOF

    chmod +x "$BOOT_SCRIPT"
    
    echo -e "${GREEN}âœ… å¼€æœºå¯åŠ¨è„šæœ¬å·²é…ç½®ï¼${NC}"
    echo -e "âš ï¸ é‡è¦æç¤ºï¼š"
    echo -e "1. è¯·ç¡®ä¿æ‰‹æœºå·²å®‰è£… **Termux:Boot** åº”ç”¨ã€‚"
    echo -e "2. è¯·åœ¨æ‰‹æœºè®¾ç½®ä¸­ï¼Œå°† Termux å’Œ Termux:Boot çš„**ç”µæ± ä¼˜åŒ–**è®¾ç½®ä¸º'æ— é™åˆ¶'ã€‚"
    echo -e "3. å»ºè®®åœ¨è¯¥è„šæœ¬æœ€åä¹Ÿé…ç½® SSH å¯åŠ¨ï¼Œä»¥é˜² Bot æŒ‚æ‰ã€‚"
}

# --- 5. å¯åŠ¨ Bot ---

start_bot() {
    echo -e "${YELLOW}[4/5] å¯åŠ¨ Bot...${NC}"
    
    # å°è¯•ç”³è¯·å”¤é†’é”
    if command -v termux-wake-lock &> /dev/null; then
        termux-wake-lock
        echo -e "å·²ç”³è¯· Wake Lock (é˜²æ­¢ä¼‘çœ )"
    fi

    pm2 delete $PM2_NAME > /dev/null 2>&1
    pm2 start $BOT_FILE --name $PM2_NAME --interpreter python --no-autorestart
    pm2 save
    
    echo -e "\n${GREEN}ğŸ‰ ç³»ç»Ÿè¿è¡Œä¸­ï¼${NC}"
    echo -e "-----------------------------------"
    echo -e "ğŸ“¡ è¿œç¨‹ SSH å»ºè®®: é…åˆ Cloudflare Tunnel é…ç½® SSH è®¿é—®"
    echo -e "âš™ï¸ å¼€æœºè‡ªå¯: ./start_bot.sh autostart"
}

# --- èœå•é€»è¾‘ ---

ACTION=${1:-start}
ARG_TOKEN=$2

case "$ACTION" in
    start)
        check_packages
        check_cloudflared
        if [ -f "$TOKEN_FILE" ]; then
            start_tunnel
        else
            echo -e "${YELLOW}æç¤º: æœªé…ç½®éš§é“ã€‚å¦‚éœ€å¤–ç½‘è®¿é—®è¯·ä½¿ç”¨ ./start_bot.sh tunnel <TOKEN>${NC}"
        fi
        start_bot
        ;;
    tunnel)
        check_packages
        check_cloudflared
        start_tunnel $ARG_TOKEN
        start_bot
        ;;
    autostart)
        setup_autostart
        ;;
    log|logs)
        pm2 log $PM2_NAME
        ;;
    stop)
        pm2 stop $PM2_NAME
        pkill -f cloudflared
        # é‡Šæ”¾å”¤é†’é”
        if command -v termux-wake-unlock &> /dev/null; then
            termux-wake-unlock
        fi
        echo "å·²åœæ­¢æ‰€æœ‰æœåŠ¡"
        ;;
    *)
        echo "ä½¿ç”¨æ–¹æ³•:"
        echo "  ./start_bot.sh tunnel <TOKEN>   # é¦–æ¬¡é…ç½®å¹¶å¯åŠ¨"
        echo "  ./start_bot.sh start            # æ­£å¸¸å¯åŠ¨ (ä½¿ç”¨å·²ä¿å­˜é…ç½®)"
        echo "  ./start_bot.sh autostart        # é…ç½®å¼€æœºè‡ªå¯ (éœ€è¦ Termux:Boot)"
        echo "  ./start_bot.sh log              # æŸ¥çœ‹æ—¥å¿—"
        ;;
esac
